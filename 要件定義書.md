# PRM Tool - 要件定義書

**プロジェクト名**: PRM Tool (Partner Relationship Management Tool)  
**バージョン**: 1.0.0  
**作成日**: 2026-01-16  
**最終更新**: 2026-01-16

---

## 📋 目次

1. [プロジェクト概要](#1-プロジェクト概要)
2. [システム要件](#2-システム要件)
3. [機能要件](#3-機能要件)
4. [非機能要件](#4-非機能要件)
5. [データベース設計](#5-データベース設計)
6. [API仕様](#6-api仕様)
7. [画面設計](#7-画面設計)
8. [セキュリティ要件](#8-セキュリティ要件)
9. [運用要件](#9-運用要件)
10. [制約事項](#10-制約事項)

---

## 1. プロジェクト概要

### 1.1 目的

パートナー企業との関係管理、案件管理、ユーザー管理を統合的に行い、業務効率を向上させるためのWebアプリケーションを開発する。

### 1.2 背景

- パートナー企業の情報が分散している
- 案件の進捗管理が非効率
- ユーザー権限管理が煩雑

### 1.3 スコープ

**含まれるもの**:
- ユーザー管理機能
- パートナー管理機能
- 案件管理機能
- 認証・認可機能
- CSV入出力機能
- スプレッドシート機能

**含まれないもの**:
- 請求管理機能
- メール送信機能
- レポート自動生成機能
- モバイルアプリ

### 1.4 想定ユーザー

- **システム管理者**: 初回セットアップのみ
- **管理者（ADMIN）**: 全機能の利用・管理
- **担当者（REP）**: 案件・パートナー管理

---

## 2. システム要件

### 2.1 技術スタック

#### Backend
| 項目 | 技術 | バージョン |
|------|------|----------|
| 言語 | Java | 17+ |
| フレームワーク | Spring Boot | 3.x |
| ORM | Hibernate (JPA) | - |
| セキュリティ | Spring Security | - |
| 認証 | JWT | - |
| ビルドツール | Maven | 3.8+ |

#### Frontend
| 項目 | 技術 | バージョン |
|------|------|----------|
| 言語 | JavaScript | ES6+ |
| ライブラリ | React | 18.x |
| ルーティング | React Router | 6.x |
| HTTP Client | Axios | - |

#### データベース
| 項目 | 技術 | バージョン |
|------|------|----------|
| RDBMS | PostgreSQL | 15+ |
| コンテナ | Docker | 20.x+ |

### 2.2 動作環境

#### サーバー要件
- **CPU**: 2コア以上
- **メモリ**: 4GB以上
- **ストレージ**: 20GB以上

#### クライアント要件
- **ブラウザ**: Chrome 90+, Firefox 88+, Edge 90+, Safari 14+
- **画面解像度**: 1280x720以上推奨

---

## 3. 機能要件

### 3.1 認証機能

#### 3.1.1 ログイン機能

**機能概要**: ユーザーがログインIDとパスワードで認証を行う

**入力項目**:
- ログインID（必須、文字列）
- パスワード（必須、文字列）

**処理フロー**:
1. ユーザーがログインIDとパスワードを入力
2. バックエンドで認証情報を検証
3. 認証成功時、JWTトークンを発行
4. トークンをフロントエンドに返却
5. フロントエンドはトークンをローカルストレージに保存
6. ダッシュボードへリダイレクト

**エラーケース**:
- 認証情報が不正な場合: 「ログインIDまたはパスワードが正しくありません」
- アカウントが無効な場合: 「このアカウントは無効です」

**API**:
- `POST /api/auth/login`

#### 3.1.2 ログアウト機能

**機能概要**: ユーザーがログアウトする

**処理フロー**:
1. ログアウトボタンをクリック
2. ローカルストレージからトークンを削除
3. ログイン画面へリダイレクト

#### 3.1.3 初回管理者作成機能

**機能概要**: アプリケーション初回起動時に自動的にSYSTEM管理者を作成

**仕様**:
- 既にSYSTEM管理者が存在する場合はスキップ
- デフォルト認証情報:
  - ログインID: `system`
  - パスワード: `SystemPass123!`
  - ロール: `SYSTEM`
  - システム保護: `true`（削除・編集不可）

**API**:
- 自動実行（DataInitializer）

---

### 3.2 アカウント管理機能

#### 3.2.1 アカウント一覧表示

**機能概要**: 登録されているアカウントの一覧を表示

**表示項目**:
- 名前
- ログインID
- メールアドレス
- 電話番号
- 役職
- ロール（管理者 / 担当者）
- 操作ボタン（編集 / 削除）

**特記事項**:
- SYSTEMロールは一覧に表示されない
- システム保護されたアカウントは「保護されたアカウント」と表示され、操作不可

**アクセス権限**: ADMIN, SYSTEM

**API**:
- `GET /api/users`

#### 3.2.2 アカウント検索・フィルター

**機能概要**: アカウントを検索・フィルタリング

**検索対象**:
- 名前
- ログインID
- メールアドレス
- 電話番号
- 役職

**フィルター**:
- ロール（全て / 管理者 / 担当者）

**特記事項**:
- 部分一致検索
- 大文字小文字を区別しない
- リアルタイム検索

#### 3.2.3 アカウント作成

**機能概要**: 新しいアカウントを作成

**入力項目**:
| 項目 | 必須 | 型 | 制約 |
|------|------|-----|------|
| 名前 | ✅ | 文字列 | 1-100文字 |
| ログインID | ✅ | 文字列 | 3-50文字、英数字のみ、重複不可 |
| パスワード | ✅ | 文字列 | 8-50文字 |
| パスワード確認 | ✅ | 文字列 | パスワードと一致必須 |
| メールアドレス | ✅ | 文字列 | メール形式 |
| 電話番号 | ❌ | 文字列 | - |
| 住所 | ❌ | 文字列 | - |
| 役職 | ❌ | 文字列 | - |
| ロール | ✅ | 列挙型 | ADMIN / REP |

**処理フロー**:
1. モーダルで入力フォームを表示
2. 入力値をバリデーション
3. パスワードと確認用パスワードの一致をチェック
4. バックエンドへPOSTリクエスト
5. 成功時、一覧を再取得してモーダルを閉じる

**バリデーション**:
- ログインIDの重複チェック
- パスワードの一致チェック
- メールアドレスの形式チェック

**アクセス権限**: ADMIN, SYSTEM

**API**:
- `POST /api/users`

#### 3.2.4 アカウント編集

**機能概要**: 既存のアカウント情報を編集

**編集可能項目**:
- 名前
- ログインID（変更不可）
- パスワード（任意）
- パスワード確認（パスワード変更時のみ必須）
- メールアドレス
- 電話番号
- 住所
- 役職
- ロール

**特記事項**:
- ログインIDは編集不可（disabled）
- パスワードは変更する場合のみ入力
- パスワード未入力の場合は変更しない
- システム保護されたアカウントは編集不可

**アクセス権限**: ADMIN, SYSTEM

**API**:
- `PUT /api/users/{id}`

#### 3.2.5 アカウント削除

**機能概要**: アカウントを削除

**処理フロー**:
1. 削除ボタンをクリック
2. 確認ダイアログを表示
3. 確認後、バックエンドへDELETEリクエスト
4. 成功時、一覧を再取得

**制約**:
- システム保護されたアカウントは削除不可
- 自分自身のアカウントは削除不可（推奨）

**アクセス権限**: ADMIN, SYSTEM

**API**:
- `DELETE /api/users/{id}`

---

### 3.3 パートナー管理機能

#### 3.3.1 パートナー一覧表示

**機能概要**: 登録されているパートナーの一覧を表示

**表示項目**:
- 会社名
- 業種
- 連絡先
- 操作ボタン（詳細 / 編集 / 削除）

**アクセス権限**: 
- 閲覧: ADMIN, REP
- 編集・削除: ADMIN のみ

**API**:
- `GET /api/partners`

#### 3.3.2 パートナー検索・フィルター

**機能概要**: パートナーを検索・フィルタリング

**検索対象**:
- 会社名
- 業種
- 連絡先名
- 連絡先情報

**フィルター**:
- 業種別

#### 3.3.3 パートナー作成

**機能概要**: 新しいパートナーを登録

**入力項目**:
| 項目 | 必須 | 型 | 制約 |
|------|------|-----|------|
| 会社名 | ✅ | 文字列 | 1-200文字 |
| 業種 | ✅ | 文字列 | 1-100文字 |
| 連絡先名 | ❌ | 文字列 | カンマ区切りで複数入力可 |
| 連絡先情報 | ❌ | 文字列 | カンマ区切りで複数入力可 |

**特記事項**:
- 連絡先名と連絡先情報は配列数が一致する必要がある
- カンマ区切りで複数の連絡先を登録可能

**アクセス権限**: ADMIN

**API**:
- `POST /api/partners`

#### 3.3.4 パートナー編集

**機能概要**: 既存のパートナー情報を編集

**編集可能項目**: 全項目

**アクセス権限**: ADMIN

**API**:
- `PUT /api/partners/{id}`

#### 3.3.5 パートナー削除

**機能概要**: パートナーを削除

**制約**:
- 関連する案件が存在する場合は削除不可

**アクセス権限**: ADMIN

**API**:
- `DELETE /api/partners/{id}`

#### 3.3.6 CSV インポート/エクスポート

**機能概要**: パートナー情報をCSV形式で入出力

**CSV形式**:
```csv
会社名,業種,連絡先名,連絡先情報
株式会社A,IT,田中太郎;山田花子,tanaka@example.com;yamada@example.com
```

**特記事項**:
- UTF-8 BOM付きで出力（Excel対応）
- 連絡先はセミコロン区切り
- エクスポートは全件

**アクセス権限**: ADMIN

**API**:
- `POST /api/partners/import`
- `GET /api/partners/export`

---

### 3.4 案件管理機能

#### 3.4.1 案件一覧表示

**機能概要**: 登録されている案件の一覧を表示

**表示項目**:
- 案件名
- パートナー名
- ステータス（新規 / 進行中 / 完了）
- オーナー
- 担当者数
- 操作ボタン（詳細 / 編集 / 削除）

**アクセス権限**: ADMIN, REP

**API**:
- `GET /api/projects`

#### 3.4.2 案件検索・フィルター

**機能概要**: 案件を検索・フィルタリング

**検索対象**:
- 案件名
- パートナー名

**フィルター**:
- ステータス別

#### 3.4.3 案件作成

**機能概要**: 新しい案件を作成

**入力項目**:
| 項目 | 必須 | 型 | 制約 |
|------|------|-----|------|
| 案件名 | ✅ | 文字列 | 1-200文字 |
| パートナー | ✅ | UUID | 既存パートナーから選択 |
| ステータス | ✅ | 列挙型 | NEW / IN_PROGRESS / DONE |
| 担当者 | ❌ | UUID配列 | 複数選択可（SYSTEMを除く） |

**特記事項**:
- 作成者が自動的にオーナーになる
- 担当者は後から追加・変更可能

**アクセス権限**: ADMIN, REP

**API**:
- `POST /api/projects`

#### 3.4.4 案件詳細・編集

**機能概要**: 案件の詳細情報を表示・編集

**表示項目**:
- 案件名
- パートナー名
- ステータス
- オーナー
- 担当者一覧
- スプレッドシート

**編集可能項目**:
- 案件名
- パートナー
- ステータス
- 担当者

**特記事項**:
- サイドバーで案件情報を表示
- メインエリアでスプレッドシート編集

**アクセス権限**: ADMIN, REP

**API**:
- `GET /api/projects/{id}`
- `PUT /api/projects/{id}`

#### 3.4.5 案件削除

**機能概要**: 案件を削除

**制約**:
- スプレッドシートデータも同時に削除される

**アクセス権限**: ADMIN

**API**:
- `DELETE /api/projects/{id}`

#### 3.4.6 スプレッドシート機能

**機能概要**: 案件の詳細データをスプレッドシート形式で管理

**仕様**:
- 24行 × 26列（A-Z）
- セルごとに値と書式を保存
- リアルタイム保存
- 書式設定（太字、斜体、下線、背景色、文字色）

**API**:
- `GET /api/projects/{id}/spreadsheet`
- `PUT /api/projects/{id}/spreadsheet`

---

### 3.5 ダッシュボード機能

**機能概要**: システムの概要を表示

**表示項目**:
- ユーザー数
- パートナー数
- 案件数（ステータス別）
- 最近の活動

**アクセス権限**: ADMIN, REP

---

## 4. 非機能要件

### 4.1 パフォーマンス要件

| 項目 | 要件 |
|------|------|
| レスポンスタイム | 3秒以内（通常操作） |
| 同時接続数 | 100ユーザー |
| データベースクエリ | 1秒以内 |

### 4.2 可用性要件

| 項目 | 要件 |
|------|------|
| 稼働率 | 99.9%（開発環境は対象外） |
| バックアップ | 日次（本番環境） |
| リカバリー時間 | 4時間以内 |

### 4.3 セキュリティ要件

| 項目 | 要件 |
|------|------|
| 認証 | JWT トークン認証 |
| パスワード | BCryptでハッシュ化 |
| トークン有効期限 | 24時間 |
| HTTPS | 本番環境では必須 |
| XSS対策 | 入力値のサニタイズ |
| CSRF対策 | トークンベース認証のため不要 |

### 4.4 互換性要件

| 項目 | 要件 |
|------|------|
| ブラウザ | Chrome 90+, Firefox 88+, Edge 90+, Safari 14+ |
| 画面解像度 | 1280x720以上推奨 |
| データベース | PostgreSQL 15+ |

### 4.5 保守性要件

| 項目 | 要件 |
|------|------|
| コーディング規約 | Java: Google Style, JavaScript: Airbnb Style |
| ログレベル | dev: DEBUG, prod: INFO |
| エラーハンドリング | 全APIでエラーレスポンス統一 |
| ドキュメント | コメント・README必須 |

---

## 5. データベース設計

### 5.1 テーブル一覧

| テーブル名 | 説明 |
|-----------|------|
| users | ユーザー情報 |
| partners | パートナー情報 |
| projects | 案件情報 |
| project_assignments | 案件担当者の関連 |
| spreadsheet_cells | スプレッドシートセル情報 |

### 5.2 users テーブル

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | UUID | NO | - | 主キー |
| name | VARCHAR(100) | NO | - | 名前 |
| login_id | VARCHAR(50) | NO | - | ログインID（一意） |
| password_hash | VARCHAR(255) | NO | - | パスワードハッシュ |
| email | VARCHAR(255) | YES | - | メールアドレス |
| phone | VARCHAR(50) | YES | - | 電話番号 |
| address | VARCHAR(500) | YES | - | 住所 |
| position | VARCHAR(100) | YES | - | 役職 |
| role | VARCHAR(20) | NO | - | ロール（SYSTEM/ADMIN/REP） |
| is_system_protected | BOOLEAN | NO | false | システム保護フラグ |
| created_by | VARCHAR(50) | YES | - | 作成者 |
| created_at | TIMESTAMP | NO | now() | 作成日時 |
| updated_at | TIMESTAMP | NO | now() | 更新日時 |

**制約**:
- PRIMARY KEY: `id`
- UNIQUE: `login_id`

### 5.3 partners テーブル

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | UUID | NO | - | 主キー |
| name | VARCHAR(200) | NO | - | 会社名 |
| industry | VARCHAR(100) | NO | - | 業種 |
| contact_names | TEXT | YES | - | 連絡先名（カンマ区切り） |
| contact_info | TEXT | YES | - | 連絡先情報（カンマ区切り） |
| created_at | TIMESTAMP | NO | now() | 作成日時 |
| updated_at | TIMESTAMP | NO | now() | 更新日時 |

**制約**:
- PRIMARY KEY: `id`

### 5.4 projects テーブル

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | UUID | NO | - | 主キー |
| name | VARCHAR(200) | NO | - | 案件名 |
| status | VARCHAR(20) | NO | 'NEW' | ステータス |
| partner_id | UUID | NO | - | パートナーID |
| owner_id | UUID | NO | - | オーナーID |
| created_at | TIMESTAMP | NO | now() | 作成日時 |
| updated_at | TIMESTAMP | NO | now() | 更新日時 |

**制約**:
- PRIMARY KEY: `id`
- FOREIGN KEY: `partner_id` → `partners(id)`
- FOREIGN KEY: `owner_id` → `users(id)`

### 5.5 project_assignments テーブル

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | UUID | NO | - | 主キー |
| project_id | UUID | NO | - | 案件ID |
| user_id | UUID | NO | - | ユーザーID |
| assigned_at | TIMESTAMP | NO | now() | 割り当て日時 |

**制約**:
- PRIMARY KEY: `id`
- FOREIGN KEY: `project_id` → `projects(id)` ON DELETE CASCADE
- FOREIGN KEY: `user_id` → `users(id)` ON DELETE CASCADE
- UNIQUE: `(project_id, user_id)`

### 5.6 spreadsheet_cells テーブル

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | UUID | NO | - | 主キー |
| project_id | UUID | NO | - | 案件ID |
| row_index | INTEGER | NO | - | 行インデックス |
| col_index | INTEGER | NO | - | 列インデックス |
| value | TEXT | YES | - | セルの値 |
| is_bold | BOOLEAN | NO | false | 太字 |
| is_italic | BOOLEAN | NO | false | 斜体 |
| is_underline | BOOLEAN | NO | false | 下線 |
| background_color | VARCHAR(20) | YES | - | 背景色 |
| text_color | VARCHAR(20) | YES | - | 文字色 |
| updated_at | TIMESTAMP | NO | now() | 更新日時 |

**制約**:
- PRIMARY KEY: `id`
- FOREIGN KEY: `project_id` → `projects(id)` ON DELETE CASCADE
- UNIQUE: `(project_id, row_index, col_index)`

---

## 6. API仕様

### 6.1 共通仕様

#### リクエストヘッダー
```
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json
```

#### レスポンス形式

**成功時**:
```json
{
  "id": "uuid",
  "name": "...",
  ...
}
```

**エラー時**:
```json
{
  "timestamp": "2026-01-16T12:00:00",
  "status": 400,
  "error": "Bad Request",
  "message": "エラーメッセージ",
  "path": "/api/users"
}
```

#### HTTPステータスコード

| コード | 説明 |
|-------|------|
| 200 | 成功 |
| 201 | 作成成功 |
| 204 | 削除成功 |
| 400 | リクエストエラー |
| 401 | 認証エラー |
| 403 | 権限エラー |
| 404 | リソースが見つからない |
| 500 | サーバーエラー |

### 6.2 認証API

#### POST /api/auth/login

**リクエスト**:
```json
{
  "loginId": "admin01",
  "password": "Password123!"
}
```

**レスポンス**:
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": "uuid",
    "name": "管理者",
    "loginId": "admin01",
    "role": "ADMIN"
  }
}
```

### 6.3 ユーザー管理API

詳細は省略（既存のAPI仕様に準拠）

---

## 7. 画面設計

### 7.1 画面一覧

| 画面名 | パス | アクセス権限 |
|-------|------|------------|
| ログイン | /login | 全員 |
| ダッシュボード | / | ADMIN, REP |
| アカウント管理 | /accounts | ADMIN, SYSTEM |
| パートナー一覧 | /partners | ADMIN, REP |
| パートナー詳細 | /partners/:id | ADMIN, REP |
| 案件一覧 | /projects | ADMIN, REP |
| 案件詳細 | /projects/:id | ADMIN, REP |

### 7.2 画面遷移図

```
ログイン
  ↓
ダッシュボード
  ├→ アカウント管理（ADMIN, SYSTEMのみ）
  ├→ パートナー一覧 → パートナー詳細
  └→ 案件一覧 → 案件詳細（スプレッドシート）
```

---

## 8. セキュリティ要件

### 8.1 認証・認可

- JWT トークンベース認証
- トークン有効期限: 24時間
- ロールベースアクセス制御（RBAC）

### 8.2 パスワードポリシー

- 最小長: 8文字
- 推奨: 英大文字・小文字・数字・記号を含む
- ハッシュ化: BCrypt（コスト: 10）

### 8.3 データ保護

- データベース接続情報は環境変数で管理
- 本番環境では必ずHTTPSを使用
- SQLインジェクション対策: PreparedStatement使用

### 8.4 セッション管理

- ステートレス（JWTトークン使用）
- トークンはローカルストレージに保存
- ログアウト時にトークンを削除

---

## 9. 運用要件

### 9.1 バックアップ

- 頻度: 日次（本番環境）
- 保持期間: 30日
- 対象: データベース全体

### 9.2 ログ

#### ログレベル
- 開発環境: DEBUG
- 本番環境: INFO

#### ログ出力内容
- アクセスログ
- エラーログ
- SQLログ（開発環境のみ）

### 9.3 監視

- アプリケーションヘルスチェック: `/api/health`
- データベース接続チェック
- ディスク使用量監視

---

## 10. 制約事項

### 10.1 技術的制約

- ブラウザのローカルストレージに依存
- PostgreSQL 15以上必須
- Java 17以上必須

### 10.2 機能的制約

- SYSTEMロールは初回セットアップ専用
- 案件に関連付けられたパートナーは削除不可
- スプレッドシートは24行×26列固定

### 10.3 運用制約

- 同時編集は未対応
- リアルタイム通知機能なし
- モバイル対応は限定的

---

## 付録

### A. 用語集

| 用語 | 説明 |
|------|------|
| PRM | Partner Relationship Management |
| JWT | JSON Web Token |
| RBAC | Role-Based Access Control |
| CRUD | Create, Read, Update, Delete |

### B. 参考資料

- Spring Boot公式ドキュメント
- React公式ドキュメント
- PostgreSQL公式ドキュメント

---

**文書履歴**

| バージョン | 日付 | 変更内容 | 作成者 |
|----------|------|---------|-------|
| 1.0.0 | 2026-01-16 | 初版作成 | 開発チーム |

---

**承認**

| 役割 | 氏名 | 日付 | 署名 |
|------|------|------|------|
| プロジェクトマネージャー | - | - | - |
| システムアーキテクト | - | - | - |
| 開発リーダー | - | - | - |
